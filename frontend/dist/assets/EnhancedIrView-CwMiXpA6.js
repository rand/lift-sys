import{r as o,j as e}from"./vendor-react-Cn3fHe9B.js";import{b as R}from"./vendor-query-CJnMiGqQ.js";import{C as N,a as O,b as Q,g as ee,c as y,B as u,S as _,A as se,e as te,f as ne}from"./index-CKTlDQLm.js";import{B as p}from"./badge-CoueLN-A.js";import{L as ie}from"./label-D0RRFWs3.js";import{I as ae}from"./input-ddRgafX1.js";import{S as re,a as le,b as ce,c as oe,d as de}from"./select-FXrsvKNO.js";import{r as me,l as xe,g as ue}from"./sessionApi-rZDVHmVb.js";import{A as pe,i as he}from"./vendor-icons-CJA_Ud5b.js";import"./vendor-radix-CJuQ3ucH.js";import"./vendor-utils-DARsLm--.js";const fe=[{id:"intent",title:"Intent"},{id:"signature",title:"Signature"},{id:"effects",title:"Effects"},{id:"assertions",title:"Assertions"}],je={intent:"Intent",signature:"Signature",effects:"Effect",assertions:"Assertion"};function He(){var q,F,V,B,P;const[i,k]=o.useState("plan"),[d,G]=o.useState(null),[h,f]=o.useState(null),[j,w]=o.useState(""),[J,H]=o.useState(!1),{data:l,isLoading:U,error:W}=R({queryKey:["plan"],queryFn:async()=>{var s;try{return(await ne.get("/api/plan")).data}catch(t){if(((s=t==null?void 0:t.response)==null?void 0:s.status)===404)return null;throw t}},staleTime:1e3*10,enabled:i==="plan"}),{data:C}=R({queryKey:["sessions"],queryFn:xe,enabled:i==="session"}),{data:a,isLoading:X,refetch:Y}=R({queryKey:["session",d],queryFn:()=>d?ue(d):Promise.resolve(null),enabled:i==="session"&&d!==null}),g=i==="plan"?l==null?void 0:l.ir:(q=a==null?void 0:a.current_draft)==null?void 0:q.ir,b=i==="plan"?((F=l==null?void 0:l.telemetry)==null?void 0:F.typed_holes)??[]:[],Z=i==="session"?(a==null?void 0:a.ambiguities)??[]:[],A=i==="plan"?((V=l==null?void 0:l.telemetry)==null?void 0:V.invariants)??[]:[],I=i==="plan"?U:X,L=i==="plan"?W:null,E=async s=>{if(!(!d||!j.trim())){H(!0);try{await me(d,s,{resolution_text:j.trim(),resolution_type:"clarify_intent"}),w(""),f(null),await Y()}catch(t){console.error("Failed to resolve hole:",t)}finally{H(!1)}}},D=o.useMemo(()=>{if(!g)return[];const s=g;return fe.map(t=>{var m,x,S,n,c,T,K,M,$;switch(t.id){case"intent":return{...t,content:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm",children:((m=s.intent)==null?void 0:m.summary)||"No intent specified"}),((x=s.intent)==null?void 0:x.rationale)&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Rationale: ",s.intent.rationale]})]})};case"signature":return{...t,content:e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Name:"})," ",((S=s.signature)==null?void 0:S.name)||"unknown"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Returns:"})," ",((n=s.signature)==null?void 0:n.returns)??"void"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Parameters"}),e.jsxs("ul",{className:"list-disc list-inside mt-1 space-y-1",children:[(!((c=s.signature)!=null&&c.parameters)||s.signature.parameters.length===0)&&e.jsx("li",{children:"None"}),(K=(T=s.signature)==null?void 0:T.parameters)==null?void 0:K.map(r=>e.jsxs("li",{children:[r.name,": ",r.type_hint]},r.name))]})]})]})};case"effects":return{...t,content:e.jsxs("ul",{className:"list-disc list-inside text-sm space-y-1",children:[(!s.effects||s.effects.length===0)&&e.jsx("li",{children:"No side effects recorded."}),(M=s.effects)==null?void 0:M.map(r=>e.jsx("li",{children:r.description},r.description))]})};case"assertions":return{...t,content:e.jsxs("ul",{className:"space-y-2",children:[(!s.assertions||s.assertions.length===0)&&e.jsx("li",{className:"text-sm",children:"No invariants provided."}),($=s.assertions)==null?void 0:$.map(r=>e.jsxs("li",{children:[e.jsx("div",{className:"font-semibold text-sm",children:r.predicate}),r.rationale&&e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:r.rationale})]},r.predicate))]})};default:return t}})},[g]),v=o.useMemo(()=>h&&i==="plan"?b.find(s=>s.identifier===h)??null:null,[b,h,i]),z=o.useMemo(()=>{const s=t=>t==="verified"?"success":t==="failed"?"error":"info";return A.map(t=>({key:t.predicate,predicate:t.predicate,variant:s(t.status??"info")}))},[A]);return e.jsx("div",{className:"space-y-6",children:e.jsxs(N,{children:[e.jsxs(O,{children:[e.jsx(Q,{children:"Intermediate Representation"}),e.jsx(ee,{children:"View and resolve IR from reverse mode plans or prompt workbench sessions"})]}),e.jsxs(y,{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Source:"}),e.jsx(u,{size:"sm",variant:i==="plan"?"default":"ghost",onClick:()=>k("plan"),children:"Plan (Reverse Mode)"}),e.jsx(u,{size:"sm",variant:i==="session"?"default":"ghost",onClick:()=>k("session"),children:"Session (Prompt)"})]}),i==="session"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{children:"Select Session"}),e.jsxs(re,{value:d??"",onValueChange:s=>G(s||null),children:[e.jsx(le,{children:e.jsx(ce,{placeholder:"-- Select a session --"})}),e.jsx(oe,{children:C==null?void 0:C.sessions.map(s=>e.jsxs(de,{value:s.session_id,children:[s.session_id.substring(0,12),"... (",s.status,", ",s.ambiguities.length," holes)"]},s.session_id))})]})]}),i==="session"&&a&&e.jsx(N,{className:"bg-muted/50",children:e.jsx(y,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Status:"}),e.jsx(p,{children:a.status})]}),e.jsx(_,{orientation:"vertical",className:"h-4"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Draft:"}),e.jsxs(p,{variant:"secondary",children:["v",((B=a.current_draft)==null?void 0:B.version)??0]})]}),e.jsx(_,{orientation:"vertical",className:"h-4"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Validation:"}),e.jsx(p,{variant:"outline",children:((P=a.current_draft)==null?void 0:P.validation_status)??"N/A"})]}),e.jsx(_,{orientation:"vertical",className:"h-4"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Holes:"}),e.jsx(p,{variant:"warning",children:a.ambiguities.length})]})]})})}),I&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading IRâ€¦"}),L&&e.jsxs(se,{variant:"destructive",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx(te,{children:"Failed to load IR."})]}),!I&&!L&&!g&&e.jsx("p",{className:"text-sm text-muted-foreground",children:i==="plan"?"Run reverse mode to generate an IR.":"Select a session to view its IR."}),g&&e.jsxs(e.Fragment,{children:[z.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:z.map(s=>e.jsx(p,{variant:s.variant,children:s.predicate},s.key))}),e.jsx("div",{className:"space-y-4",children:D.map((s,t)=>{const m=b.filter(n=>n.clause===s.id),x=Z.filter(n=>n.includes(s.id)),S=m.length>0||x.length>0;return e.jsx(N,{className:"bg-card/60",children:e.jsxs("details",{open:t===0,children:[e.jsxs("summary",{className:"cursor-pointer font-semibold flex items-center gap-2 p-6 hover:opacity-80 transition-opacity",children:[e.jsx(he,{className:"h-4 w-4 transition-transform [[open]>&]:rotate-180"}),s.title,S&&e.jsxs(p,{variant:"warning",className:"ml-2 text-xs",children:[m.length+x.length," holes"]})]}),e.jsxs(y,{className:"space-y-3 pt-0",children:[s.content,m.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:m.map(n=>e.jsx(u,{size:"sm",variant:h===n.identifier?"default":"outline",onClick:()=>f(c=>c===n.identifier?null:n.identifier),className:"rounded-full",children:`<?${n.identifier}: ${n.type_hint}>`},n.identifier))}),i==="session"&&x.length>0&&e.jsx("div",{className:"space-y-3",children:x.map(n=>e.jsx(N,{className:"border-warning bg-warning/5",children:e.jsxs(y,{className:"pt-6 space-y-3",children:[e.jsx("code",{className:"text-sm font-medium text-warning",children:n}),h===n?e.jsxs("div",{className:"flex gap-2 items-end",children:[e.jsx("div",{className:"flex-1",children:e.jsx(ae,{value:j,onChange:c=>w(c.target.value),placeholder:"Enter resolution...",onKeyDown:c=>{c.key==="Enter"&&j.trim()&&E(n)}})}),e.jsx(u,{size:"sm",onClick:()=>void E(n),disabled:J||!j.trim(),children:"Resolve"}),e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>{f(null),w("")},children:"Cancel"})]}):e.jsx(u,{size:"sm",variant:"outline",onClick:()=>f(n),children:"Resolve hole"})]})},n))})]})]})},s.id)})}),v&&i==="plan"&&e.jsxs(N,{className:"bg-accent/90","aria-live":"polite",children:[e.jsx(O,{children:e.jsx(Q,{className:"text-base",children:"Planner Assist"})}),e.jsxs(y,{className:"space-y-3",children:[e.jsx("p",{className:"text-sm opacity-85",children:v.description||"No description provided."}),e.jsx(p,{variant:"info",children:je[v.clause]}),v.assist&&e.jsx("p",{className:"text-sm mt-3",children:v.assist}),e.jsx(u,{size:"sm",onClick:()=>f(null),children:"Dismiss"})]})]})]})]})]})})}export{He as EnhancedIrView};
