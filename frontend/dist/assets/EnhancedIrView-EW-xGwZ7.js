import{r as l,j as e}from"./vendor-react-Cn3fHe9B.js";import{b as _}from"./vendor-query-CJnMiGqQ.js";import{h as u,C as b,a as Q,b as G,g as pe,c as S,B as j,S as H,A as he,e as fe,f as je}from"./index-CA5AEePF.js";import{B as g}from"./badge-DVFEUDXu.js";import{L as ge}from"./label-BnKKdPLI.js";import{I as Ne}from"./input-BOecAI1S.js";import{h as ve,V as ye,i as J,j as we,k as be,l as W,m as Se,n as X,o as Ce,p as Re,q as Y,r as Z,s as ee,t as se}from"./vendor-radix-ERXSFEfG.js";import{f as L,a as ke,g as Ie,A as _e}from"./vendor-icons-Bamum9f2.js";import{r as He,l as Le,g as ze}from"./sessionApi-DEQ7l0Sy.js";import"./vendor-utils-DARsLm--.js";const Ae=ve,Be=ye,te=l.forwardRef(({className:t,children:i,...a},x)=>e.jsxs(J,{ref:x,className:u("flex h-10 w-full items-center justify-between rounded-lg border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground transition-all duration-200 ease-smooth focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",t),...a,children:[i,e.jsx(we,{asChild:!0,children:e.jsx(L,{className:"h-4 w-4 opacity-50"})})]}));te.displayName=J.displayName;const ae=l.forwardRef(({className:t,...i},a)=>e.jsx(Y,{ref:a,className:u("flex cursor-default items-center justify-center py-1",t),...i,children:e.jsx(Ie,{className:"h-4 w-4"})}));ae.displayName=Y.displayName;const ne=l.forwardRef(({className:t,...i},a)=>e.jsx(Z,{ref:a,className:u("flex cursor-default items-center justify-center py-1",t),...i,children:e.jsx(L,{className:"h-4 w-4"})}));ne.displayName=Z.displayName;const re=l.forwardRef(({className:t,children:i,position:a="popper",...x},p)=>e.jsx(be,{children:e.jsxs(W,{ref:p,className:u("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-lg border bg-popover text-popover-foreground shadow-md transition-all duration-200 ease-smooth data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",t),position:a,...x,children:[e.jsx(ae,{}),e.jsx(Se,{className:u("p-1",a==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:i}),e.jsx(ne,{})]})}));re.displayName=W.displayName;const Ve=l.forwardRef(({className:t,...i},a)=>e.jsx(ee,{ref:a,className:u("px-2 py-1.5 text-sm font-semibold",t),...i}));Ve.displayName=ee.displayName;const ie=l.forwardRef(({className:t,children:i,...a},x)=>e.jsxs(X,{ref:x,className:u("relative flex w-full cursor-default select-none items-center rounded-md py-1.5 pl-2 pr-8 text-sm outline-none transition-colors duration-200 ease-smooth focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),...a,children:[e.jsx("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Ce,{children:e.jsx(ke,{className:"h-4 w-4"})})}),e.jsx(Re,{children:i})]}));ie.displayName=X.displayName;const Ee=l.forwardRef(({className:t,...i},a)=>e.jsx(se,{ref:a,className:u("-mx-1 my-1 h-px bg-muted",t),...i}));Ee.displayName=se.displayName;const qe=[{id:"intent",title:"Intent"},{id:"signature",title:"Signature"},{id:"effects",title:"Effects"},{id:"assertions",title:"Assertions"}],Te={intent:"Intent",signature:"Signature",effects:"Effect",assertions:"Assertion"};function Je(){var T,F,P,K,M;const[t,i]=l.useState("plan"),[a,x]=l.useState(null),[p,N]=l.useState(null),[v,R]=l.useState(""),[le,z]=l.useState(!1),{data:d,isLoading:oe,error:ce}=_({queryKey:["plan"],queryFn:async()=>{var s;try{return(await je.get("/plan")).data}catch(n){if(((s=n==null?void 0:n.response)==null?void 0:s.status)===404)return null;throw n}},staleTime:1e3*10,enabled:t==="plan"}),{data:k}=_({queryKey:["sessions"],queryFn:Le,enabled:t==="session"}),{data:o,isLoading:de,refetch:me}=_({queryKey:["session",a],queryFn:()=>a?ze(a):Promise.resolve(null),enabled:t==="session"&&a!==null}),y=t==="plan"?d==null?void 0:d.ir:(T=o==null?void 0:o.current_draft)==null?void 0:T.ir,I=t==="plan"?((F=d==null?void 0:d.telemetry)==null?void 0:F.typed_holes)??[]:[],ue=t==="session"?(o==null?void 0:o.ambiguities)??[]:[],A=t==="plan"?((P=d==null?void 0:d.telemetry)==null?void 0:P.invariants)??[]:[],B=t==="plan"?oe:de,V=t==="plan"?ce:null,E=async s=>{if(!(!a||!v.trim())){z(!0);try{await He(a,s,{resolution_text:v.trim(),resolution_type:"clarify_intent"}),R(""),N(null),await me()}catch(n){console.error("Failed to resolve hole:",n)}finally{z(!1)}}},xe=l.useMemo(()=>{if(!y)return[];const s=y;return qe.map(n=>{var h,f,C,r,m,$,U,D,O;switch(n.id){case"intent":return{...n,content:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm",children:((h=s.intent)==null?void 0:h.summary)||"No intent specified"}),((f=s.intent)==null?void 0:f.rationale)&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Rationale: ",s.intent.rationale]})]})};case"signature":return{...n,content:e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Name:"})," ",((C=s.signature)==null?void 0:C.name)||"unknown"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Returns:"})," ",((r=s.signature)==null?void 0:r.returns)??"void"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Parameters"}),e.jsxs("ul",{className:"list-disc list-inside mt-1 space-y-1",children:[(!((m=s.signature)!=null&&m.parameters)||s.signature.parameters.length===0)&&e.jsx("li",{children:"None"}),(U=($=s.signature)==null?void 0:$.parameters)==null?void 0:U.map(c=>e.jsxs("li",{children:[c.name,": ",c.type_hint]},c.name))]})]})]})};case"effects":return{...n,content:e.jsxs("ul",{className:"list-disc list-inside text-sm space-y-1",children:[(!s.effects||s.effects.length===0)&&e.jsx("li",{children:"No side effects recorded."}),(D=s.effects)==null?void 0:D.map(c=>e.jsx("li",{children:c.description},c.description))]})};case"assertions":return{...n,content:e.jsxs("ul",{className:"space-y-2",children:[(!s.assertions||s.assertions.length===0)&&e.jsx("li",{className:"text-sm",children:"No invariants provided."}),(O=s.assertions)==null?void 0:O.map(c=>e.jsxs("li",{children:[e.jsx("div",{className:"font-semibold text-sm",children:c.predicate}),c.rationale&&e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:c.rationale})]},c.predicate))]})};default:return n}})},[y]),w=l.useMemo(()=>p&&t==="plan"?I.find(s=>s.identifier===p)??null:null,[I,p,t]),q=l.useMemo(()=>{const s=n=>n==="verified"?"success":n==="failed"?"error":"info";return A.map(n=>({key:n.predicate,predicate:n.predicate,variant:s(n.status??"info")}))},[A]);return e.jsx("div",{className:"space-y-6",children:e.jsxs(b,{children:[e.jsxs(Q,{children:[e.jsx(G,{children:"Intermediate Representation"}),e.jsx(pe,{children:"View and resolve IR from reverse mode plans or prompt workbench sessions"})]}),e.jsxs(S,{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Source:"}),e.jsx(j,{size:"sm",variant:t==="plan"?"default":"ghost",onClick:()=>i("plan"),children:"Plan (Reverse Mode)"}),e.jsx(j,{size:"sm",variant:t==="session"?"default":"ghost",onClick:()=>i("session"),children:"Session (Prompt)"})]}),t==="session"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{children:"Select Session"}),e.jsxs(Ae,{value:a??"",onValueChange:s=>x(s||null),children:[e.jsx(te,{children:e.jsx(Be,{placeholder:"-- Select a session --"})}),e.jsx(re,{children:k==null?void 0:k.sessions.map(s=>e.jsxs(ie,{value:s.session_id,children:[s.session_id.substring(0,12),"... (",s.status,", ",s.ambiguities.length," holes)"]},s.session_id))})]})]}),t==="session"&&o&&e.jsx(b,{className:"bg-muted/50",children:e.jsx(S,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Status:"}),e.jsx(g,{children:o.status})]}),e.jsx(H,{orientation:"vertical",className:"h-4"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Draft:"}),e.jsxs(g,{variant:"secondary",children:["v",((K=o.current_draft)==null?void 0:K.version)??0]})]}),e.jsx(H,{orientation:"vertical",className:"h-4"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Validation:"}),e.jsx(g,{variant:"outline",children:((M=o.current_draft)==null?void 0:M.validation_status)??"N/A"})]}),e.jsx(H,{orientation:"vertical",className:"h-4"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Holes:"}),e.jsx(g,{variant:"warning",children:o.ambiguities.length})]})]})})}),B&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading IRâ€¦"}),V&&e.jsxs(he,{variant:"destructive",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx(fe,{children:"Failed to load IR."})]}),!B&&!V&&!y&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t==="plan"?"Run reverse mode to generate an IR.":"Select a session to view its IR."}),y&&e.jsxs(e.Fragment,{children:[q.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:q.map(s=>e.jsx(g,{variant:s.variant,children:s.predicate},s.key))}),e.jsx("div",{className:"space-y-4",children:xe.map((s,n)=>{const h=I.filter(r=>r.clause===s.id),f=ue.filter(r=>r.includes(s.id)),C=h.length>0||f.length>0;return e.jsx(b,{className:"bg-card/60",children:e.jsxs("details",{open:n===0,children:[e.jsxs("summary",{className:"cursor-pointer font-semibold flex items-center gap-2 p-6 hover:opacity-80 transition-opacity",children:[e.jsx(L,{className:"h-4 w-4 transition-transform [[open]>&]:rotate-180"}),s.title,C&&e.jsxs(g,{variant:"warning",className:"ml-2 text-xs",children:[h.length+f.length," holes"]})]}),e.jsxs(S,{className:"space-y-3 pt-0",children:[s.content,h.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:h.map(r=>e.jsx(j,{size:"sm",variant:p===r.identifier?"default":"outline",onClick:()=>N(m=>m===r.identifier?null:r.identifier),className:"rounded-full",children:`<?${r.identifier}: ${r.type_hint}>`},r.identifier))}),t==="session"&&f.length>0&&e.jsx("div",{className:"space-y-3",children:f.map(r=>e.jsx(b,{className:"border-warning bg-warning/5",children:e.jsxs(S,{className:"pt-6 space-y-3",children:[e.jsx("code",{className:"text-sm font-medium text-warning",children:r}),p===r?e.jsxs("div",{className:"flex gap-2 items-end",children:[e.jsx("div",{className:"flex-1",children:e.jsx(Ne,{value:v,onChange:m=>R(m.target.value),placeholder:"Enter resolution...",onKeyDown:m=>{m.key==="Enter"&&v.trim()&&E(r)}})}),e.jsx(j,{size:"sm",onClick:()=>void E(r),disabled:le||!v.trim(),children:"Resolve"}),e.jsx(j,{size:"sm",variant:"ghost",onClick:()=>{N(null),R("")},children:"Cancel"})]}):e.jsx(j,{size:"sm",variant:"outline",onClick:()=>N(r),children:"Resolve hole"})]})},r))})]})]})},s.id)})}),w&&t==="plan"&&e.jsxs(b,{className:"bg-accent/90","aria-live":"polite",children:[e.jsx(Q,{children:e.jsx(G,{className:"text-base",children:"Planner Assist"})}),e.jsxs(S,{className:"space-y-3",children:[e.jsx("p",{className:"text-sm opacity-85",children:w.description||"No description provided."}),e.jsx(g,{variant:"info",children:Te[w.clause]}),w.assist&&e.jsx("p",{className:"text-sm mt-3",children:w.assist}),e.jsx(j,{size:"sm",onClick:()=>N(null),children:"Dismiss"})]})]})]})]})]})})}export{Je as EnhancedIrView};
