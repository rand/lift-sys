import{r as o,j as e}from"./vendor-react-Cn3fHe9B.js";import{h as V,C as _,a as $,b as O,B as v,c as k,A as L,i as Q,e as U,g as X,S as Y,f as be,d as _e}from"./index-CKTlDQLm.js";import{I as Ce}from"./input-ddRgafX1.js";import{B as u}from"./badge-CoueLN-A.js";import{S as G,u as Se}from"./useProgressStream-CUoGBWFQ.js";import{l as ke,g as le,d as Re,c as Ee,f as ze,r as Ae,a as De}from"./sessionApi-rZDVHmVb.js";import{w as Fe,x as Te,y as xe,z as Ie,A as me,D as he,O as ue,B as $e,E as Oe,H as Ve,F as fe,G as je}from"./vendor-radix-CJuQ3ucH.js";import{X as K,i as Be,a as ce,e as W,k as Z,l as oe,I as ee,m as q,A as J,T as He,n as Pe,G as Me,W as Ge,o as se,p as Le,q as Ue,B as We,U as qe,L as Je,r as Ke,R as Qe}from"./vendor-icons-CJA_Ud5b.js";import"./vendor-query-CJnMiGqQ.js";import"./vendor-utils-DARsLm--.js";const ge=o.forwardRef(({className:r,...a},l)=>e.jsx("textarea",{className:V("flex min-h-[80px] w-full rounded-lg border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 transition-all duration-200",r),ref:l,...a}));ge.displayName="Textarea";const de=Fe,Xe=Te,pe=o.forwardRef(({className:r,...a},l)=>e.jsx(ue,{ref:l,className:V("fixed inset-0 z-50 bg-background/80 backdrop-blur-sm data-[state=open]:animate-fade-in data-[state=closed]:animate-fade-out",r),...a}));pe.displayName=ue.displayName;const te=o.forwardRef(({className:r,children:a,...l},j)=>e.jsxs(Xe,{children:[e.jsx(pe,{}),e.jsxs(xe,{ref:j,className:V("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-card p-6 shadow-lg duration-200 data-[state=open]:animate-fade-in data-[state=closed]:animate-fade-out sm:rounded-lg",r),...l,children:[a,e.jsxs(Ie,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));te.displayName=xe.displayName;const ae=({className:r,...a})=>e.jsx("div",{className:V("flex flex-col space-y-1.5 text-center sm:text-left",r),...a});ae.displayName="DialogHeader";const re=({className:r,...a})=>e.jsx("div",{className:V("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",r),...a});re.displayName="DialogFooter";const ne=o.forwardRef(({className:r,...a},l)=>e.jsx(me,{ref:l,className:V("text-lg font-semibold leading-none tracking-tight",r),...a}));ne.displayName=me.displayName;const ie=o.forwardRef(({className:r,...a},l)=>e.jsx(he,{ref:l,className:V("text-sm text-muted-foreground",r),...a}));ie.displayName=he.displayName;const Ye=$e,Ne=o.forwardRef(({className:r,...a},l)=>e.jsx(Oe,{ref:l,className:V("border-b",r),...a}));Ne.displayName="AccordionItem";const ve=o.forwardRef(({className:r,children:a,...l},j)=>e.jsx(Ve,{className:"flex",children:e.jsxs(fe,{ref:j,className:V("flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180 duration-200",r),...l,children:[a,e.jsx(Be,{className:"h-4 w-4 shrink-0 transition-transform duration-200"})]})}));ve.displayName=fe.displayName;const ye=o.forwardRef(({className:r,children:a,...l},j)=>e.jsx(je,{ref:j,className:"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down",...l,children:e.jsx("div",{className:V("pb-4 pt-0",r),children:a})}));ye.displayName=je.displayName;const Ze={intent:"Intent",signature:"Signature",assertion:"Assertions",effect:"Effects",metadata:"Metadata"};function es({comparison:r,leftLabel:a="Original",rightLabel:l="Compared",sideBySide:j=!0,enableActions:n=!1,onAcceptDiff:g,onRejectDiff:E,onAcceptAll:y,onRejectAll:z}){const[A,F]=o.useState(new Set),[w,f]=o.useState(new Set),N=[...r.intent_comparison.diffs,...r.signature_comparison.diffs,...r.assertion_comparison.diffs,...r.effect_comparison.diffs,...r.metadata_comparison.diffs],R=s=>`${s.category}-${s.path}`,D=s=>{const x=R(s);F(m=>new Set(m).add(x)),f(m=>{const p=new Set(m);return p.delete(x),p}),g==null||g(s)},H=s=>{const x=R(s);f(m=>new Set(m).add(x)),F(m=>{const p=new Set(m);return p.delete(x),p}),E==null||E(s)},c=()=>{const s=N.map(R);F(new Set(s)),f(new Set),y==null||y()},h=()=>{const s=N.map(R);f(new Set(s)),F(new Set),z==null||z()},i=s=>{switch(s){case"error":return e.jsx(oe,{className:"h-4 w-4 text-red-500"});case"warning":return e.jsx(Z,{className:"h-4 w-4 text-yellow-500"});case"info":return e.jsx(ee,{className:"h-4 w-4 text-blue-500"})}},P=s=>{const x={error:"bg-red-100 text-red-800 border-red-300",warning:"bg-yellow-100 text-yellow-800 border-yellow-300",info:"bg-blue-100 text-blue-800 border-blue-300"};return e.jsx(u,{variant:"outline",className:x[s],children:s.toUpperCase()})},T=s=>s>=.9?"text-green-600":s>=.7?"text-yellow-600":"text-red-600",M=s=>{const x=Math.round(s*100);return s>=.9?e.jsxs(u,{className:"bg-green-600",children:[e.jsx(W,{className:"mr-1 h-3 w-3"}),x,"% Match"]}):s>=.7?e.jsxs(u,{className:"bg-yellow-600",children:[e.jsx(Z,{className:"mr-1 h-3 w-3"}),x,"% Match"]}):e.jsxs(u,{variant:"destructive",children:[e.jsx(oe,{className:"mr-1 h-3 w-3"}),x,"% Match"]})},C=s=>s==null?e.jsx("span",{className:"text-muted-foreground italic",children:"none"}):typeof s=="object"?e.jsx("code",{className:"text-xs bg-muted px-2 py-1 rounded",children:JSON.stringify(s)}):e.jsx("code",{className:"text-xs bg-muted px-2 py-1 rounded",children:String(s)}),I=s=>{const x=R(s),m=A.has(x),p=w.has(x);return e.jsxs("div",{className:`border rounded-lg p-4 space-y-3 ${m?"border-green-300 bg-green-50":p?"border-red-300 bg-red-50":"border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[i(s.severity),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-sm",children:s.kind.replace(/_/g," ")}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.path})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[P(s.severity),n&&e.jsxs("div",{className:"flex gap-1",children:[e.jsx(v,{size:"sm",variant:m?"default":"outline",onClick:()=>D(s),className:"h-7 px-2",children:e.jsx(ce,{className:"h-3 w-3"})}),e.jsx(v,{size:"sm",variant:p?"destructive":"outline",onClick:()=>H(s),className:"h-7 px-2",children:e.jsx(K,{className:"h-3 w-3"})})]})]})]}),s.message&&e.jsx("div",{className:"text-sm text-muted-foreground",children:s.message}),j?e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold mb-1 text-red-600",children:a}),C(s.left_value)]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold mb-1 text-green-600",children:l}),C(s.right_value)]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-xs font-semibold text-red-600",children:[a,": "]}),C(s.left_value)]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-xs font-semibold text-green-600",children:[l,": "]}),C(s.right_value)]})]})]},x)},t=s=>{const x=Ze[s.category],m=s.diffs.length>0;return e.jsxs(Ne,{value:s.category,children:[e.jsx(ve,{className:"hover:no-underline",children:e.jsxs("div",{className:"flex items-center justify-between w-full pr-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:x}),m&&e.jsxs(u,{variant:"outline",children:[s.diffs.length," differences"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:`text-sm font-semibold ${T(s.similarity)}`,children:[Math.round(s.similarity*100),"%"]}),!m&&e.jsx(W,{className:"h-4 w-4 text-green-600"})]})]})}),e.jsx(ye,{children:m?e.jsx("div",{className:"space-y-3 pt-2",children:s.diffs.map(p=>I(p))}):e.jsx("div",{className:"text-sm text-muted-foreground py-4 text-center",children:"No differences in this category"})})]})},d=N.filter(s=>s.severity==="error").length,b=N.filter(s=>s.severity==="warning").length,S=N.filter(s=>s.severity==="info").length;return e.jsxs(_,{className:"w-full",children:[e.jsxs($,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(O,{children:"IR Comparison"}),M(r.overall_similarity)]}),n&&N.length>0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(v,{size:"sm",variant:"outline",onClick:c,children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Accept All"]}),e.jsxs(v,{size:"sm",variant:"outline",onClick:h,children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"Reject All"]})]})]}),N.length>0&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[d>0&&e.jsxs(u,{variant:"outline",className:"bg-red-100 text-red-800",children:[d," errors"]}),b>0&&e.jsxs(u,{variant:"outline",className:"bg-yellow-100 text-yellow-800",children:[b," warnings"]}),S>0&&e.jsxs(u,{variant:"outline",className:"bg-blue-100 text-blue-800",children:[S," info"]})]})]}),e.jsx(k,{children:N.length===0?e.jsxs(L,{children:[e.jsx(W,{className:"h-4 w-4"}),e.jsx(Q,{children:"IRs are identical"}),e.jsx(U,{children:"No differences found between the two intermediate representations."})]}):e.jsx(G,{className:"h-[600px] pr-4",children:e.jsxs(Ye,{type:"multiple",defaultValue:["intent","signature","assertion"],children:[t(r.intent_comparison),t(r.signature_comparison),t(r.assertion_comparison),t(r.effect_comparison),t(r.metadata_comparison)]})})})]})}function ss({sessionId:r,onVersionChange:a}){const[l,j]=o.useState(null),[n,g]=o.useState(!0),[E,y]=o.useState(null),[z,A]=o.useState(null),[F,w]=o.useState(null),[f,N]=o.useState(null),[R,D]=o.useState(!1),[H,c]=o.useState(!1),[h,i]=o.useState(null),[P,T]=o.useState(!1);o.useEffect(()=>{M()},[r]);const M=async()=>{try{g(!0);const s=await fetch(`/api/spec-sessions/${r}/versions`,{credentials:"include"});if(!s.ok)throw new Error(`Failed to fetch version history: ${s.statusText}`);const x=await s.json();j(x),y(null)}catch(s){y(s instanceof Error?s.message:"Failed to load version history")}finally{g(!1)}},C=async(s,x)=>{try{const m=await fetch(`/api/spec-sessions/${r}/versions/${s}/compare/${x}`,{credentials:"include"});if(!m.ok)throw new Error("Failed to compare versions");const p=await m.json();N(p),D(!0)}catch(m){y(m instanceof Error?m.message:"Failed to compare versions")}},I=async(s,x=!0)=>{try{if(T(!0),!(await fetch(`/api/spec-sessions/${r}/versions/${s}/rollback`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({target_version:s,create_new_version:x})})).ok)throw new Error("Failed to rollback");await M(),a&&a(s),c(!1),i(null)}catch(m){y(m instanceof Error?m.message:"Failed to rollback")}finally{T(!1)}},t=s=>{switch(s){case"human":return e.jsx(qe,{className:"h-3 w-3"});case"agent":return e.jsx(We,{className:"h-3 w-3"});case"reverse":return e.jsx(Ue,{className:"h-3 w-3"});case"merge":return e.jsx(Le,{className:"h-3 w-3"});case"verification":return e.jsx(se,{className:"h-3 w-3"});case"refinement":return e.jsx(Ge,{className:"h-3 w-3"});default:return e.jsx(J,{className:"h-3 w-3"})}},d=s=>{switch(s){case"human":return"bg-blue-500";case"agent":return"bg-purple-500";case"reverse":return"bg-green-500";case"merge":return"bg-orange-500";case"verification":return"bg-teal-500";case"refinement":return"bg-indigo-500";default:return"bg-gray-500"}},b=s=>{const x=new Date(s);return new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(x)},S=s=>{if(!s)return"unknown";const x=Object.entries(s);if(x.length===0)return"unknown";const[m]=x.reduce((p,B)=>B[1]>p[1]?B:p);return m};return n?e.jsxs(_,{children:[e.jsx($,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5"}),"Version History"]})}),e.jsx(k,{children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full"})})})]}):E?e.jsxs(L,{variant:"destructive",children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx(Q,{children:"Error"}),e.jsx(U,{children:E})]}):!l||l.versions.length===0?e.jsxs(_,{children:[e.jsx($,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5"}),"Version History"]})}),e.jsx(k,{children:e.jsx("p",{className:"text-muted-foreground text-center py-8",children:"No version history available"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(_,{children:[e.jsx($,{children:e.jsxs(O,{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5"}),"Version History"]}),e.jsxs(u,{variant:"outline",children:[l.versions.length," version",l.versions.length!==1?"s":""]})]})}),e.jsx(k,{children:e.jsx(G,{className:"h-[600px] pr-4",children:e.jsx("div",{className:"space-y-4",children:l.versions.map((s,x)=>{const m=s.version===l.current_version,p=S(s.provenance_summary);return e.jsxs("div",{className:"relative",children:[x<l.versions.length-1&&e.jsx("div",{className:"absolute left-[19px] top-[60px] h-[calc(100%+16px)] w-[2px] bg-border"}),e.jsx(_,{className:m?"border-primary":"",children:e.jsx(k,{className:"pt-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs("div",{className:`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${m?"bg-primary text-primary-foreground":"bg-muted"}`,children:["v",s.version]}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("h4",{className:"font-semibold flex items-center gap-2",children:[s.change_summary||`Version ${s.version}`,m&&e.jsx(u,{variant:"default",className:"text-xs",children:"Current"})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 text-sm text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(q,{className:"h-3 w-3"}),b(s.created_at)]}),s.author&&e.jsxs("span",{className:"flex items-center gap-1",children:[t(p),s.author]})]}),Object.keys(s.provenance_summary).length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-2",children:Object.entries(s.provenance_summary).map(([B,we])=>e.jsxs(u,{variant:"secondary",className:"text-xs",children:[e.jsx("span",{className:`inline-block w-2 h-2 rounded-full mr-1 ${d(B)}`}),B,": ",we]},B))}),s.tags.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-2",children:s.tags.map(B=>e.jsxs(u,{variant:"outline",className:"text-xs",children:[e.jsx(He,{className:"h-3 w-3 mr-1"}),B]},B))}),s.has_holes&&e.jsx("div",{className:"mt-2",children:e.jsxs(u,{variant:"secondary",className:"text-xs",children:[e.jsx(J,{className:"h-3 w-3 mr-1"}),s.hole_count," unresolved hole",s.hole_count!==1?"s":""]})})]}),e.jsx("div",{className:"flex items-center gap-2",children:!m&&e.jsxs(e.Fragment,{children:[e.jsxs(v,{size:"sm",variant:"outline",onClick:()=>{i(s.version),c(!0)},children:[e.jsx(Pe,{className:"h-4 w-4 mr-1"}),"Restore"]}),e.jsxs(v,{size:"sm",variant:"outline",onClick:()=>C(s.version,l.current_version),children:[e.jsx(Me,{className:"h-4 w-4 mr-1"}),"Compare"]})]})})]})})]})})})]},s.version)})})})})]}),e.jsx(de,{open:R,onOpenChange:D,children:e.jsxs(te,{className:"max-w-6xl h-[80vh]",children:[e.jsxs(ae,{children:[e.jsxs(ne,{children:["Version Comparison: v",f==null?void 0:f.from_version," → v",f==null?void 0:f.to_version]}),e.jsx(ie,{children:"Showing changes between the two versions"})]}),f&&e.jsx(G,{className:"flex-1",children:e.jsx(es,{fromIR:f.from_ir,toIR:f.to_ir,comparison:f.comparison})}),e.jsx(re,{children:e.jsx(v,{variant:"outline",onClick:()=>D(!1),children:"Close"})})]})}),e.jsx(de,{open:H,onOpenChange:c,children:e.jsxs(te,{children:[e.jsxs(ae,{children:[e.jsxs(ne,{children:["Restore Version ",h,"?"]}),e.jsxs(ie,{children:["This will create a new version based on version ",h,". The current version will be preserved in history."]})]}),e.jsxs(L,{children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx(Q,{children:"Note"}),e.jsxs(U,{children:["This action will create version ",l.current_version+1," as a copy of version"," ",h,". All versions remain accessible in the history."]})]}),e.jsxs(re,{children:[e.jsx(v,{variant:"outline",onClick:()=>c(!1),disabled:P,children:"Cancel"}),e.jsx(v,{onClick:()=>h&&I(h,!0),disabled:P,children:P?"Restoring...":"Restore Version"})]})]})})]})}function ts({sessionId:r}){const[a,l]=o.useState(null),[j,n]=o.useState(!1),[g,E]=o.useState(null),[y,z]=o.useState(new Set),A=async()=>{n(!0),E(null);try{const c=await be.post(`/api/spec-sessions/${r}/analyze`);l(c.data)}catch(c){console.error("Failed to analyze IR:",c),E(c instanceof Error?c.message:"Failed to analyze IR")}finally{n(!1)}},F=c=>{z(h=>{const i=new Set(h);return i.has(c)?i.delete(c):i.add(c),i})},w=c=>{switch(c){case"critical":return e.jsx(Ke,{className:"h-4 w-4 text-red-600"});case"high":return e.jsx(Z,{className:"h-4 w-4 text-orange-500"});case"medium":return e.jsx(ee,{className:"h-4 w-4 text-yellow-500"});case"low":return e.jsx(Je,{className:"h-4 w-4 text-blue-500"});default:return e.jsx(ee,{className:"h-4 w-4 text-gray-500"})}},f=c=>{switch(c){case"critical":return"destructive";case"high":return"default";case"medium":return"secondary";case"low":return"outline";default:return"outline"}},N=c=>{switch(c){case"type_safety":return"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200";case"documentation":return"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";case"security":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";case"error_handling":return"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200";case"completeness":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200";case"best_practices":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";default:return"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200"}},R=c=>c.split("_").map(h=>h.charAt(0).toUpperCase()+h.slice(1)).join(" "),D=c=>c>=.8?"text-green-600":c>=.6?"text-yellow-600":"text-red-600",H=c=>{const h={};for(const i of c)h[i.category]||(h[i.category]=[]),h[i.category].push(i);return h};return e.jsxs(_,{children:[e.jsx($,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx(O,{children:"IR Quality Analysis"}),e.jsx(X,{children:"Proactive suggestions to improve your specification"})]}),e.jsx(v,{onClick:A,disabled:j,variant:"outline",children:j?"Analyzing...":"Analyze IR"})]})}),e.jsxs(k,{children:[g&&e.jsx(L,{variant:"destructive",className:"mb-4",children:e.jsx(U,{children:g})}),a&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(se,{className:"h-8 w-8 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Overall Quality Score"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Based on ",a.summary_stats.total," suggestion(s)"]})]})]}),e.jsxs("div",{className:`text-4xl font-bold ${D(a.overall_quality_score)}`,children:[(a.overall_quality_score*100).toFixed(0),"%"]})]}),a.summary_stats.total>0&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[a.summary_stats.critical>0&&e.jsxs(u,{variant:"destructive",children:[a.summary_stats.critical," Critical"]}),a.summary_stats.high>0&&e.jsxs(u,{variant:"default",children:[a.summary_stats.high," High"]}),a.summary_stats.medium>0&&e.jsxs(u,{variant:"secondary",children:[a.summary_stats.medium," Medium"]}),a.summary_stats.low>0&&e.jsxs(u,{variant:"outline",children:[a.summary_stats.low," Low"]})]}),a.suggestions.length>0?e.jsx(G,{className:"h-[400px]",children:e.jsx("div",{className:"space-y-4 pr-4",children:Object.entries(H(a.suggestions)).map(([c,h])=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{className:N(c),children:R(c)}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[h.length," issue",h.length!==1?"s":""]})]}),h.map((i,P)=>{const T=a.suggestions.indexOf(i),M=y.has(T);return e.jsx(_,{className:"cursor-pointer hover:bg-muted/50 transition-colors",onClick:()=>F(T),children:e.jsx(k,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[w(i.severity),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("h4",{className:"font-medium text-sm",children:i.title}),e.jsx(u,{variant:f(i.severity),children:i.severity})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["📍 ",i.location]}),M&&e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"my-2"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsx("p",{className:"text-muted-foreground",children:i.description}),i.current_value&&e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-xs mb-1",children:"Current:"}),e.jsx("code",{className:"text-xs bg-muted px-2 py-1 rounded",children:i.current_value})]}),i.suggested_value&&e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-xs mb-1",children:"Suggested:"}),e.jsx("code",{className:"text-xs bg-muted px-2 py-1 rounded",children:i.suggested_value})]}),i.rationale&&e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-xs mb-1",children:"Why:"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.rationale})]}),i.examples.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-xs mb-1",children:"Examples:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-xs text-muted-foreground",children:i.examples.map((C,I)=>e.jsx("li",{children:C},I))})]}),i.references.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-xs mb-1",children:"References:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-xs text-muted-foreground",children:i.references.map((C,I)=>e.jsx("li",{children:C},I))})]})]})]})]})]})})},T)})]},c))})}):e.jsxs(L,{children:[e.jsx(se,{className:"h-4 w-4"}),e.jsx(U,{children:"Great work! No issues found in your IR specification."})]})]}),!a&&!g&&!j&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:'Click "Analyze IR" to get quality insights and improvement suggestions.'})]})]})}function hs(){var C,I;const[r,a]=o.useState(""),[l,j]=o.useState([]),[n,g]=o.useState(null),[E,y]=o.useState([]),[z,A]=o.useState(!1),[F,w]=o.useState(null),[f,N]=o.useState({}),{events:R}=Se();o.useEffect(()=>{D()},[]),o.useEffect(()=>{const t=R.filter(d=>d.scope==="spec_sessions");if(t.length>0){const d=t[t.length-1];d.session_id&&(n==null?void 0:n.session_id)===d.session_id&&H(),d.type==="session_created"&&D()}},[R,n]);const D=async()=>{try{const t=await ke();j(t.sessions)}catch(t){console.error("Failed to load sessions:",t)}},H=async()=>{if(n)try{const t=await le(n.session_id);g(t)}catch(t){console.error("Failed to refresh session:",t)}},c=async()=>{if(!r.trim()){w("Please enter a prompt");return}A(!0),w(null);try{const t=await Ee({prompt:r.trim()});g(t),j([t,...l]),t.ambiguities.length>0&&await i(t.session_id),a("")}catch(t){w(t instanceof Error?t.message:"Failed to create session")}finally{A(!1)}},h=async t=>{g(t),w(null),t.ambiguities.length>0&&await i(t.session_id)},i=async t=>{try{const d=await De(t);y(d.assists)}catch(d){console.error("Failed to load assists:",d)}},P=async t=>{if(!n)return;const d=f[t];if(!(d!=null&&d.trim())){w(`Please enter a resolution for ${t}`);return}A(!0),w(null);try{const b=await Ae(n.session_id,t,{resolution_text:d.trim(),resolution_type:"clarify_intent"});g(b),N(S=>{const s={...S};return delete s[t],s}),b.ambiguities.length>0?await i(b.session_id):y([])}catch(b){w(b instanceof Error?b.message:"Failed to resolve hole")}finally{A(!1)}},T=async()=>{if(n){A(!0),w(null);try{await ze(n.session_id);const t=await le(n.session_id);g(t),y([])}catch(t){w(t instanceof Error?t.message:"Failed to finalize session")}finally{A(!1)}}},M=async t=>{try{await Re(t),j(l.filter(d=>d.session_id!==t)),(n==null?void 0:n.session_id)===t&&(g(null),y([]))}catch(d){w(d instanceof Error?d.message:"Failed to delete session")}};return e.jsxs("div",{className:"grid grid-cols-[300px_1fr] gap-6 h-full",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs(_,{children:[e.jsx($,{className:"pb-3",children:e.jsx(O,{className:"text-xl",children:"Sessions"})}),e.jsx(k,{children:e.jsxs(v,{onClick:()=>void D(),variant:"outline",className:"w-full",children:[e.jsx(Qe,{className:"h-4 w-4 mr-2"}),"Refresh"]})})]}),e.jsx(G,{className:"flex-1",children:e.jsxs("div",{className:"flex flex-col gap-2",children:[l.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground italic px-2",children:"No sessions yet. Create one to get started."}),l.map(t=>e.jsx(_,{className:`cursor-pointer transition-colors ${(n==null?void 0:n.session_id)===t.session_id?"bg-accent border-brand":"hover:bg-accent/50"}`,onClick:()=>void h(t),children:e.jsx(k,{className:"p-3",children:e.jsxs("div",{className:"flex justify-between items-start gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"text-sm font-medium truncate",children:[t.session_id.substring(0,8),"..."]}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx(u,{variant:"secondary",className:"text-xs",children:t.status}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[t.ambiguities.length," holes"]})]})]}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:d=>{d.stopPropagation(),M(t.session_id)},children:e.jsx(K,{className:"h-4 w-4"})})]})})},t.session_id))]})})]}),e.jsx(G,{className:"flex-1",children:e.jsxs("div",{className:"flex flex-col gap-6",children:[e.jsxs(_,{children:[e.jsxs($,{children:[e.jsx(O,{className:"text-2xl",children:"Prompt Workbench"}),e.jsx(X,{children:"Describe your specification in natural language. The system will translate it to IR and identify ambiguities."})]}),e.jsxs(k,{className:"space-y-4",children:[e.jsx(ge,{value:r,onChange:t=>a(t.target.value),placeholder:"e.g., A function that takes two integers and returns their sum...",className:"min-h-[120px] resize-y"}),F&&e.jsx(L,{variant:"destructive",children:e.jsx(U,{children:F})})]}),e.jsx(_e,{children:e.jsx(v,{onClick:()=>void c(),disabled:z||!r.trim(),className:"w-full",children:z?"Creating...":"Create Session"})})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx(_,{children:e.jsx($,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(O,{children:["Session ",n.session_id.substring(0,12)]}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Status:"}),e.jsx(u,{children:n.status})]}),e.jsx(Y,{orientation:"vertical",className:"h-4"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Draft:"}),e.jsxs(u,{variant:"secondary",children:["v",((C=n.current_draft)==null?void 0:C.version)??0]})]}),e.jsx(Y,{orientation:"vertical",className:"h-4"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Validation:"}),e.jsx(u,{variant:"outline",children:((I=n.current_draft)==null?void 0:I.validation_status)??"N/A"})]})]})]}),n.status==="active"&&n.ambiguities.length===0&&e.jsxs(v,{onClick:()=>void T(),disabled:z,children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"Finalize"]})]})})}),n.current_draft&&e.jsxs(_,{children:[e.jsx($,{children:e.jsx(O,{children:"Intermediate Representation"})}),e.jsx(k,{children:e.jsx(G,{className:"h-[300px]",children:e.jsx("pre",{className:"text-sm font-mono bg-muted p-4 rounded-md",children:JSON.stringify(n.current_draft.ir,null,2)})})})]}),e.jsx(ss,{sessionId:n.session_id,onVersionChange:()=>void H()}),e.jsx(ts,{sessionId:n.session_id}),n.ambiguities.length>0&&e.jsxs(_,{children:[e.jsxs($,{children:[e.jsxs(O,{children:["Ambiguities (",n.ambiguities.length,")"]}),e.jsx(X,{children:"Resolve these ambiguities to refine your specification."})]}),e.jsx(k,{className:"space-y-4",children:n.ambiguities.map(t=>{var b;const d=E.find(S=>S.hole_id===t);return e.jsx(_,{children:e.jsxs(k,{className:"pt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("code",{className:"text-sm font-semibold bg-muted px-2 py-1 rounded",children:t}),d&&e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:d.context})]}),d&&d.suggestions.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Suggestions:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.suggestions.map((S,s)=>e.jsx(v,{variant:"secondary",size:"sm",className:"text-xs h-7",onClick:()=>N(x=>({...x,[t]:S})),children:S},s))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Ce,{value:f[t]??"",onChange:S=>N(s=>({...s,[t]:S.target.value})),placeholder:"Enter resolution...",className:"flex-1"}),e.jsx(v,{onClick:()=>void P(t),disabled:z||!((b=f[t])!=null&&b.trim()),size:"sm",children:"Resolve"})]})]})},t)})})]}),n.status==="finalized"&&e.jsxs(L,{variant:"success",children:[e.jsx(W,{className:"h-4 w-4"}),e.jsx(U,{children:"Session finalized! The IR is now ready for code generation."})]})]})]})})]})}export{hs as PromptWorkbenchView};
