import{r,j as s}from"./vendor-react-Cn3fHe9B.js";import{h as K,C as c,a as p,b as g,c as h,B as f,g as z,A as P,e as D,d as M,S as T}from"./index-CA5AEePF.js";import{I as Q}from"./input-BOecAI1S.js";import{B as y}from"./badge-DVFEUDXu.js";import{u as U,S as k}from"./useProgressStream-Befj3wwJ.js";import{l as Y,g as B,d as Z,c as I,f as ss,r as es,a as ts}from"./sessionApi-DEQ7l0Sy.js";import{R as is,X as as,e as H}from"./vendor-icons-Bamum9f2.js";import"./vendor-query-CJnMiGqQ.js";import"./vendor-radix-ERXSFEfG.js";import"./vendor-utils-DARsLm--.js";const L=r.forwardRef(({className:o,...j},d)=>s.jsx("textarea",{className:K("flex min-h-[80px] w-full rounded-lg border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 transition-all duration-200",o),ref:d,...j}));L.displayName="Textarea";function fs(){var R,F;const[o,j]=r.useState(""),[d,b]=r.useState([]),[t,x]=r.useState(null),[V,v]=r.useState([]),[N,m]=r.useState(!1),[A,a]=r.useState(null),[w,_]=r.useState({}),{events:E}=U();r.useEffect(()=>{S()},[]),r.useEffect(()=>{const e=E.filter(i=>i.scope==="spec_sessions");if(e.length>0){const i=e[e.length-1];i.session_id&&(t==null?void 0:t.session_id)===i.session_id&&W(),i.type==="session_created"&&S()}},[E,t]);const S=async()=>{try{const e=await Y();b(e.sessions)}catch(e){console.error("Failed to load sessions:",e)}},W=async()=>{if(t)try{const e=await B(t.session_id);x(e)}catch(e){console.error("Failed to refresh session:",e)}},$=async()=>{if(!o.trim()){a("Please enter a prompt");return}m(!0),a(null);try{const e=await I({prompt:o.trim()});x(e),b([e,...d]),e.ambiguities.length>0&&await C(e.session_id),j("")}catch(e){a(e instanceof Error?e.message:"Failed to create session")}finally{m(!1)}},J=async e=>{x(e),a(null),e.ambiguities.length>0&&await C(e.session_id)},C=async e=>{try{const i=await ts(e);v(i.assists)}catch(i){console.error("Failed to load assists:",i)}},O=async e=>{if(!t)return;const i=w[e];if(!(i!=null&&i.trim())){a(`Please enter a resolution for ${e}`);return}m(!0),a(null);try{const n=await es(t.session_id,e,{resolution_text:i.trim(),resolution_type:"clarify_intent"});x(n),_(l=>{const u={...l};return delete u[e],u}),n.ambiguities.length>0?await C(n.session_id):v([])}catch(n){a(n instanceof Error?n.message:"Failed to resolve hole")}finally{m(!1)}},X=async()=>{if(t){m(!0),a(null);try{await ss(t.session_id);const e=await B(t.session_id);x(e),v([])}catch(e){a(e instanceof Error?e.message:"Failed to finalize session")}finally{m(!1)}}},q=async e=>{try{await Z(e),b(d.filter(i=>i.session_id!==e)),(t==null?void 0:t.session_id)===e&&(x(null),v([]))}catch(i){a(i instanceof Error?i.message:"Failed to delete session")}};return s.jsxs("div",{className:"grid grid-cols-[300px_1fr] gap-6 h-full",children:[s.jsxs("div",{className:"flex flex-col gap-4",children:[s.jsxs(c,{children:[s.jsx(p,{className:"pb-3",children:s.jsx(g,{className:"text-xl",children:"Sessions"})}),s.jsx(h,{children:s.jsxs(f,{onClick:()=>void S(),variant:"outline",className:"w-full",children:[s.jsx(is,{className:"h-4 w-4 mr-2"}),"Refresh"]})})]}),s.jsx(k,{className:"flex-1",children:s.jsxs("div",{className:"flex flex-col gap-2",children:[d.length===0&&s.jsx("p",{className:"text-sm text-muted-foreground italic px-2",children:"No sessions yet. Create one to get started."}),d.map(e=>s.jsx(c,{className:`cursor-pointer transition-colors ${(t==null?void 0:t.session_id)===e.session_id?"bg-accent border-brand":"hover:bg-accent/50"}`,onClick:()=>void J(e),children:s.jsx(h,{className:"p-3",children:s.jsxs("div",{className:"flex justify-between items-start gap-2",children:[s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs("div",{className:"text-sm font-medium truncate",children:[e.session_id.substring(0,8),"..."]}),s.jsxs("div",{className:"flex gap-2 mt-1",children:[s.jsx(y,{variant:"secondary",className:"text-xs",children:e.status}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:[e.ambiguities.length," holes"]})]})]}),s.jsx(f,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:i=>{i.stopPropagation(),q(e.session_id)},children:s.jsx(as,{className:"h-4 w-4"})})]})})},e.session_id))]})})]}),s.jsx(k,{className:"flex-1",children:s.jsxs("div",{className:"flex flex-col gap-6",children:[s.jsxs(c,{children:[s.jsxs(p,{children:[s.jsx(g,{className:"text-2xl",children:"Prompt Workbench"}),s.jsx(z,{children:"Describe your specification in natural language. The system will translate it to IR and identify ambiguities."})]}),s.jsxs(h,{className:"space-y-4",children:[s.jsx(L,{value:o,onChange:e=>j(e.target.value),placeholder:"e.g., A function that takes two integers and returns their sum...",className:"min-h-[120px] resize-y"}),A&&s.jsx(P,{variant:"destructive",children:s.jsx(D,{children:A})})]}),s.jsx(M,{children:s.jsx(f,{onClick:()=>void $(),disabled:N||!o.trim(),className:"w-full",children:N?"Creating...":"Create Session"})})]}),t&&s.jsxs(s.Fragment,{children:[s.jsx(c,{children:s.jsx(p,{children:s.jsxs("div",{className:"flex justify-between items-start",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs(g,{children:["Session ",t.session_id.substring(0,12)]}),s.jsxs("div",{className:"flex flex-wrap gap-2 text-sm",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"text-muted-foreground",children:"Status:"}),s.jsx(y,{children:t.status})]}),s.jsx(T,{orientation:"vertical",className:"h-4"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"text-muted-foreground",children:"Draft:"}),s.jsxs(y,{variant:"secondary",children:["v",((R=t.current_draft)==null?void 0:R.version)??0]})]}),s.jsx(T,{orientation:"vertical",className:"h-4"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"text-muted-foreground",children:"Validation:"}),s.jsx(y,{variant:"outline",children:((F=t.current_draft)==null?void 0:F.validation_status)??"N/A"})]})]})]}),t.status==="active"&&t.ambiguities.length===0&&s.jsxs(f,{onClick:()=>void X(),disabled:N,children:[s.jsx(H,{className:"h-4 w-4 mr-2"}),"Finalize"]})]})})}),t.current_draft&&s.jsxs(c,{children:[s.jsx(p,{children:s.jsx(g,{children:"Intermediate Representation"})}),s.jsx(h,{children:s.jsx(k,{className:"h-[300px]",children:s.jsx("pre",{className:"text-sm font-mono bg-muted p-4 rounded-md",children:JSON.stringify(t.current_draft.ir,null,2)})})})]}),t.ambiguities.length>0&&s.jsxs(c,{children:[s.jsxs(p,{children:[s.jsxs(g,{children:["Ambiguities (",t.ambiguities.length,")"]}),s.jsx(z,{children:"Resolve these ambiguities to refine your specification."})]}),s.jsx(h,{className:"space-y-4",children:t.ambiguities.map(e=>{var n;const i=V.find(l=>l.hole_id===e);return s.jsx(c,{children:s.jsxs(h,{className:"pt-6 space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx("code",{className:"text-sm font-semibold bg-muted px-2 py-1 rounded",children:e}),i&&s.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:i.context})]}),i&&i.suggestions.length>0&&s.jsxs("div",{className:"space-y-2",children:[s.jsx("p",{className:"text-xs text-muted-foreground",children:"Suggestions:"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:i.suggestions.map((l,u)=>s.jsx(f,{variant:"secondary",size:"sm",className:"text-xs h-7",onClick:()=>_(G=>({...G,[e]:l})),children:l},u))})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(Q,{value:w[e]??"",onChange:l=>_(u=>({...u,[e]:l.target.value})),placeholder:"Enter resolution...",className:"flex-1"}),s.jsx(f,{onClick:()=>void O(e),disabled:N||!((n=w[e])!=null&&n.trim()),size:"sm",children:"Resolve"})]})]})},e)})})]}),t.status==="finalized"&&s.jsxs(P,{variant:"success",children:[s.jsx(H,{className:"h-4 w-4"}),s.jsx(D,{children:"Session finalized! The IR is now ready for code generation."})]})]})]})})]})}export{fs as PromptWorkbenchView};
