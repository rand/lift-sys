import{r as n,j as e}from"./vendor-react-Cn3fHe9B.js";import{b as Le,u as ie}from"./vendor-query-CJnMiGqQ.js";import{C as m,a as $,b as T,g as I,c as u,B as h,A as L,e as P,S as ce,f as Q}from"./index-DvBOCnyf.js";import{B as b}from"./badge-C9OZR10L.js";import{L as V}from"./label-Chi6Up9_.js";import{I as B}from"./input-CFtq0vHI.js";import{u as Pe,S as de}from"./useProgressStream-BqEr5rOL.js";import{S as oe,a as me,b as xe,c as ue,d as f}from"./select-C9F1RFMV.js";import{R as Ee,f as he,A as pe,F as Fe,g as _e,e as ze,h as Me}from"./vendor-icons-DF3oxMVR.js";import"./vendor-radix-ERXSFEfG.js";import"./vendor-utils-DARsLm--.js";const $e={completed:"success",running:"info",ready:"warning",failed:"error"};function Ke(){var se,te,ae;const[N,G]=n.useState(null),[p,je]=n.useState(null),[S,U]=n.useState("project"),[O,ge]=n.useState("module.py"),[K,fe]=n.useState("main"),[E,W]=n.useState([]),[J,Ne]=n.useState(null),[i,ve]=n.useState(null),[w,ye]=n.useState(""),[v,X]=n.useState(null),[a,Y]=n.useState(null),[g,be]=n.useState(""),[D,Se]=n.useState("updated"),[Z,Te]=n.useState("desc"),[F,we]=n.useState("all"),[_,k]=n.useState(1),[z,M]=n.useState([]),q=n.useRef(new Set),{events:ee}=Pe(),C=n.useMemo(()=>ee.filter(s=>s.scope==="reverse"),[ee]),c=Le({queryKey:["repositories",_,D,Z],queryFn:async()=>(await Q.get("/api/repos",{params:{page:_,per_page:30,sort:D,direction:Z}})).data.repositories??[]});n.useEffect(()=>{c.data&&M(_===1?c.data:s=>[...s,...c.data])},[c.data,_]);const x=n.useMemo(()=>{let s=z;if(g){const t=g.toLowerCase();s=s.filter(l=>{var r;return l.name.toLowerCase().includes(t)||l.owner.toLowerCase().includes(t)||((r=l.description)==null?void 0:r.toLowerCase().includes(t))})}return F!=="all"&&(s=s.filter(t=>F==="private"?t.private:!t.private)),s},[z,g,F]),R=n.useMemo(()=>{if(!i)return null;if(!w)return i;const s=w.toLowerCase();return i.filter(t=>{var o,j,A,ne,re,le;const l=((j=(o=t.metadata)==null?void 0:o.source_path)==null?void 0:j.toLowerCase())||"",r=((ne=(A=t.intent)==null?void 0:A.summary)==null?void 0:ne.toLowerCase())||"",d=((le=(re=t.signature)==null?void 0:re.name)==null?void 0:le.toLowerCase())||"";return l.includes(s)||r.includes(s)||d.includes(s)})},[i,w]);n.useEffect(()=>{!x||x.length===0||G(s=>s??x[0])},[x]);const Ce=()=>{k(1),M([]),c.refetch()},Re=()=>{k(s=>s+1)},Ae=c.data&&c.data.length===30,y=ie({mutationFn:async()=>{if(!N)throw new Error("Repository selection required");return(await Q.post("/api/repos/open",{identifier:N.identifier})).data},onSuccess:s=>{je(s.repository),c.refetch()}}),H=ie({mutationFn:async()=>{const s=await Q.post("/api/reverse",{module:S==="project"?null:O,queries:["security/default"],entrypoint:K,analyze_all:S==="project"});return q.current=new Set,W(s.data.progress??[]),s.data},onSuccess:s=>{s.irs&&s.irs.length>0&&ve(s.irs)}});return n.useEffect(()=>{!E.length||!C.length||W(s=>{let t=!1;const l=s.map(r=>{const d=C.filter(o=>o.stage===r.id).find(o=>{const j=`${o.stage}-${o.status}-${o.timestamp}`;return q.current.has(j)?!1:(q.current.add(j),!0)});return d?(t=!0,{...r,status:d.status??r.status,message:d.message??r.message,timestamp:d.timestamp??r.timestamp}):r});return t?l:s})},[C,E.length]),n.useEffect(()=>{const s=C.filter(l=>l.stage==="file_analysis");if(s.length===0)return;const t=s[s.length-1];t.status==="running"&&t.current&&t.total&&t.file?X({file:String(t.file),current:Number(t.current),total:Number(t.total)}):t.status==="completed"&&X(null)},[C]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(m,{children:[e.jsxs($,{children:[e.jsx(T,{children:"Repository"}),e.jsx(I,{children:"Connect one of your GitHub repositories to lift specifications."})]}),e.jsxs(u,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center flex-wrap gap-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Repositories"}),e.jsxs(h,{variant:"outline",size:"sm",onClick:Ce,disabled:c.isLoading,children:[e.jsx(Ee,{className:"h-4 w-4 mr-2"}),"Refresh"]})]}),e.jsxs("div",{className:"grid gap-3 grid-cols-1 md:grid-cols-3",children:[e.jsxs("div",{className:"relative md:col-span-2",children:[e.jsx(he,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(B,{placeholder:"Search repositories...",value:g,onChange:s=>be(s.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs(oe,{value:F,onValueChange:s=>we(s),children:[e.jsx(me,{children:e.jsx(xe,{})}),e.jsxs(ue,{children:[e.jsx(f,{value:"all",children:"All Repos"}),e.jsx(f,{value:"public",children:"Public"}),e.jsx(f,{value:"private",children:"Private"})]})]}),e.jsxs(oe,{value:D,onValueChange:s=>{Se(s),k(1),M([])},children:[e.jsx(me,{children:e.jsx(xe,{})}),e.jsxs(ue,{children:[e.jsx(f,{value:"updated",children:"Recently Updated"}),e.jsx(f,{value:"created",children:"Recently Created"}),e.jsx(f,{value:"pushed",children:"Recently Pushed"}),e.jsx(f,{value:"full_name",children:"Name"})]})]})]})]}),c.isLoading?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading repositories…"}):c.isError?e.jsxs(L,{variant:"destructive",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx(P,{children:"Unable to load repositories. Ensure GitHub access is configured."})]}):x&&x.length>0?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"grid gap-3 grid-cols-1 md:grid-cols-2 lg:grid-cols-3",children:x.map(s=>{const t=(N==null?void 0:N.identifier)===s.identifier;return e.jsx(m,{className:`cursor-pointer transition-all ${t?"border-brand bg-accent":"hover:bg-accent/50"}`,onClick:()=>G(s),children:e.jsxs(u,{className:"p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"font-semibold text-base",children:s.name}),s.private&&e.jsx(b,{variant:"secondary",className:"text-xs",children:"Private"})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.owner}),s.description&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.description}),e.jsxs("div",{className:"text-xs text-muted-foreground pt-2",children:["Default branch: ",s.defaultBranch,s.lastSynced&&` • Synced ${new Date(s.lastSynced).toLocaleTimeString()}`]})]})},s.identifier)})}),Ae&&!g&&e.jsx("div",{className:"flex justify-center",children:e.jsx(h,{variant:"outline",onClick:Re,disabled:c.isLoading,children:c.isLoading?"Loading...":"Load More"})}),g&&z.length>x.length&&e.jsxs("p",{className:"text-sm text-muted-foreground text-center",children:["Showing ",x.length," of ",z.length," loaded repositories"]})]}):g?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No repositories match your search."}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No repositories available. Connect GitHub to continue."})]}),e.jsx(ce,{}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Reverse Mode Analysis"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Extract specifications from existing code using static and dynamic analysis."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Analysis Scope"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{variant:S==="project"?"default":"outline",size:"sm",onClick:()=>U("project"),disabled:!p,children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Entire Project"]}),e.jsxs(h,{variant:S==="file"?"default":"outline",size:"sm",onClick:()=>U("file"),disabled:!p,children:[e.jsx(_e,{className:"h-4 w-4 mr-2"}),"Specific File"]})]})]}),S==="project"?e.jsx(L,{children:e.jsx(P,{children:"Will analyze all Python files in the repository, excluding common directories like venv, node_modules, and __pycache__."})}):e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"module",children:"Target Module Path"}),e.jsx(B,{id:"module",value:O,onChange:s=>ge(s.target.value),placeholder:"src/main.py",disabled:!p}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Path relative to repository root (e.g., src/main.py, lib/core.py)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"entrypoint",children:"Entrypoint Function"}),e.jsx(B,{id:"entrypoint",value:K,onChange:s=>fe(s.target.value),placeholder:"main",disabled:!p}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Function name to analyze for dynamic invariants"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-3 flex-wrap",children:[e.jsx(h,{onClick:()=>y.mutate(),disabled:!N||y.isPending,children:y.isPending?"Opening…":"Open Repository"}),e.jsx(h,{variant:"outline",onClick:()=>H.mutate(),disabled:H.isPending||y.isError||!p,children:H.isPending?"Scanning…":"Run Reverse Scan"})]}),v&&e.jsx(L,{children:e.jsx(P,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"font-medium",children:["Analyzing: ",v.file]}),e.jsxs("span",{className:"text-muted-foreground",children:[v.current," / ",v.total]})]}),e.jsx("div",{className:"w-full bg-secondary rounded-full h-2",children:e.jsx("div",{className:"bg-brand h-2 rounded-full transition-all duration-300",style:{width:`${v.current/v.total*100}%`}})})]})})})]}),y.isSuccess&&p&&e.jsxs(L,{variant:"success",children:[e.jsx(ze,{className:"h-4 w-4"}),e.jsxs(P,{children:["Repository ",e.jsx("strong",{children:p.name})," synced from ",p.owner,"."]})]}),y.isError&&e.jsxs(L,{variant:"destructive",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx(P,{children:"Unable to open repository. Check your permissions and try again."})]})]})]}),e.jsxs(m,{children:[e.jsx($,{children:e.jsx(T,{children:"Repository Scan Timeline"})}),e.jsx(u,{children:E.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Trigger reverse mode to view progress checkpoints."}):e.jsx(de,{className:"h-[400px]",children:e.jsx("ol",{className:"space-y-4",children:E.map(s=>e.jsxs("li",{className:"border-l-2 border-brand/50 pl-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(b,{variant:$e[s.status]??"secondary",children:s.label}),e.jsx("span",{className:"text-sm",children:s.message})]}),s.actions&&s.actions.length>0&&e.jsx("div",{className:"flex gap-2 flex-wrap",children:s.actions.map(t=>e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>Ne(`${s.label}: ${t.label}${t.value?` (${t.value})`:""}`),children:t.label},t.label))}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.timestamp?new Date(s.timestamp).toLocaleTimeString():"Awaiting timestamp"})]},s.id))})})})]}),i&&i.length>0&&e.jsxs(m,{children:[e.jsxs($,{children:[e.jsx(T,{children:"Analysis Results"}),e.jsx(I,{children:i.length===1?"Specification extracted from 1 file":`Specifications extracted from ${i.length} files`})]}),e.jsxs(u,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsx(m,{className:"bg-accent/50",children:e.jsxs(u,{className:"pt-6",children:[e.jsx("div",{className:"text-2xl font-bold",children:i.length}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Files Analyzed"})]})}),e.jsx(m,{className:"bg-accent/50",children:e.jsxs(u,{className:"pt-6",children:[e.jsx("div",{className:"text-2xl font-bold",children:i.reduce((s,t)=>{var r,d;const l=((d=(r=t.intent)==null?void 0:r.holes)==null?void 0:d.length)||0;return s+l},0)}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Typed Holes Found"})]})}),e.jsx(m,{className:"bg-accent/50",children:e.jsxs(u,{className:"pt-6",children:[e.jsx("div",{className:"text-2xl font-bold",children:i.reduce((s,t)=>{var r;const l=((r=t.assertions)==null?void 0:r.length)||0;return s+l},0)}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Assertions Generated"})]})})]}),e.jsx(ce,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Analyzed Files"}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(he,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(B,{placeholder:"Search results...",value:w,onChange:s=>ye(s.target.value),className:"pl-10"})]})]}),R&&R.length>0?e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"h-[300px]",children:e.jsx("div",{className:"space-y-2",children:R.map((s,t)=>{var l,r,d,o,j,A;return e.jsx(m,{className:"p-4 hover:bg-accent/50 transition-colors",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-start gap-4",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("div",{className:"font-mono text-sm font-semibold",children:((l=s.metadata)==null?void 0:l.source_path)||`File ${t+1}`}),e.jsx("div",{className:"text-sm text-muted-foreground line-clamp-2",children:((r=s.intent)==null?void 0:r.summary)||"No summary available"})]}),e.jsx(h,{variant:"outline",size:"sm",onClick:()=>Y(s),children:"View Details"})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(b,{variant:"secondary",className:"text-xs",children:((d=s.signature)==null?void 0:d.name)||"Unknown"}),((j=(o=s.intent)==null?void 0:o.holes)==null?void 0:j.length)>0&&e.jsxs(b,{variant:"warning",className:"text-xs",children:[s.intent.holes.length," holes"]}),((A=s.assertions)==null?void 0:A.length)>0&&e.jsxs(b,{variant:"info",className:"text-xs",children:[s.assertions.length," assertions"]})]})]})},t)})})}),w&&i.length>R.length&&e.jsxs("p",{className:"text-sm text-muted-foreground text-center",children:["Showing ",R.length," of ",i.length," results"]})]}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No results match your search."})]})]})]}),a&&e.jsxs(m,{children:[e.jsxs($,{children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(h,{variant:"ghost",size:"sm",onClick:()=>Y(null),children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Back to Results"]})}),e.jsx(T,{className:"text-xl mt-4",children:((se=a.metadata)==null?void 0:se.source_path)||"Specification Details"}),e.jsx(I,{children:((te=a.intent)==null?void 0:te.summary)||"No summary available"})]}),e.jsxs(u,{className:"space-y-6",children:[a.signature&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Signature"}),e.jsx("div",{className:"bg-muted p-4 rounded-lg font-mono text-sm",children:e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-600 dark:text-blue-400",children:"def"})," ",e.jsx("span",{className:"font-bold",children:a.signature.name}),"(",(ae=a.signature.parameters)==null?void 0:ae.map((s,t)=>e.jsxs("span",{children:[t>0&&", ",e.jsx("span",{children:s.name}),s.type_hint&&e.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:[": ",s.type_hint]})]},t)),")",a.signature.returns&&e.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:[" ","-> ",a.signature.returns]})]})})]}),a.intent&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Intent"}),e.jsxs("div",{className:"bg-muted p-4 rounded-lg space-y-2",children:[e.jsx("p",{className:"text-sm",children:a.intent.summary}),a.intent.rationale&&e.jsx("p",{className:"text-sm text-muted-foreground italic",children:a.intent.rationale}),a.intent.holes&&a.intent.holes.length>0&&e.jsxs("div",{className:"mt-3 space-y-1",children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground",children:["Typed Holes (",a.intent.holes.length,"):"]}),a.intent.holes.map((s,t)=>e.jsx(b,{variant:"warning",className:"text-xs mr-1",children:s.identifier},t))]})]})]}),a.effects&&a.effects.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Effects"}),e.jsx("div",{className:"space-y-2",children:a.effects.map((s,t)=>e.jsx("div",{className:"bg-muted p-3 rounded-lg",children:e.jsx("p",{className:"text-sm",children:s.description})},t))})]}),a.assertions&&a.assertions.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Assertions"}),e.jsx("div",{className:"space-y-2",children:a.assertions.map((s,t)=>e.jsxs("div",{className:"bg-muted p-3 rounded-lg space-y-1",children:[e.jsx("code",{className:"text-sm font-mono",children:s.predicate}),s.rationale&&e.jsx("p",{className:"text-xs text-muted-foreground italic",children:s.rationale})]},t))})]}),a.metadata&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Metadata"}),e.jsx("div",{className:"bg-muted p-3 rounded-lg",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[a.metadata.origin&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Origin:"})," ",e.jsx("span",{className:"font-medium",children:a.metadata.origin})]}),a.metadata.language&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Language:"})," ",e.jsx("span",{className:"font-medium",children:a.metadata.language})]}),a.metadata.source_path&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Path:"})," ",e.jsx("span",{className:"font-mono text-xs",children:a.metadata.source_path})]})]})})]})]})]}),J&&e.jsx(m,{className:"bg-accent/50",children:e.jsxs(u,{className:"pt-6 space-y-1",children:[e.jsx("div",{className:"font-semibold",children:"Action"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:J})]})})]})}export{Ke as RepositoryView};
