import{r as a,j as e}from"./vendor-react-Cn3fHe9B.js";import{b as G,u as A}from"./vendor-query-CJnMiGqQ.js";import{C as u,a as $,b as L,g as z,c as x,B as p,A as j,e as y,f as v}from"./index-CA5AEePF.js";import{B as I}from"./badge-DVFEUDXu.js";import{L as B}from"./label-BnKKdPLI.js";import{I as T}from"./input-BOecAI1S.js";import{u as O,S as Q}from"./useProgressStream-Befj3wwJ.js";import{R as U,A as D,e as K}from"./vendor-icons-Bamum9f2.js";import"./vendor-radix-ERXSFEfG.js";import"./vendor-utils-DARsLm--.js";const V={completed:"success",running:"info",ready:"warning",failed:"error"};function re(){const[i,N]=a.useState(null),[d,F]=a.useState(null),[b,M]=a.useState("module.py"),[w,P]=a.useState("main"),[c,S]=a.useState([]),[C,q]=a.useState(null),h=a.useRef(new Set),{events:R}=O(),g=a.useMemo(()=>R.filter(s=>s.scope==="reverse"),[R]),t=G({queryKey:["repositories"],queryFn:async()=>(await v.get("/repos")).data.repositories??[]});a.useEffect(()=>{!t.data||t.data.length===0||N(s=>s??t.data[0])},[t.data]);const n=A({mutationFn:async()=>{if(!i)throw new Error("Repository selection required");return(await v.post("/repos/open",{identifier:i.identifier})).data},onSuccess:s=>{F(s.repository),t.refetch()}}),f=A({mutationFn:async()=>{const s=await v.post("/reverse",{module:b,queries:["security/default"],entrypoint:w});return h.current=new Set,S(s.data.progress??[]),s.data}});return a.useEffect(()=>{!c.length||!g.length||S(s=>{let r=!1;const H=s.map(l=>{const m=g.filter(o=>o.stage===l.id).find(o=>{const E=`${o.stage}-${o.status}-${o.timestamp}`;return h.current.has(E)?!1:(h.current.add(E),!0)});return m?(r=!0,{...l,status:m.status??l.status,message:m.message??l.message,timestamp:m.timestamp??l.timestamp}):l});return r?H:s})},[g,c.length]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(u,{children:[e.jsxs($,{children:[e.jsx(L,{children:"Repository"}),e.jsx(z,{children:"Connect one of your GitHub repositories to lift specifications."})]}),e.jsxs(x,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center flex-wrap gap-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Repositories"}),e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>t.refetch(),disabled:t.isLoading,children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),"Refresh"]})]}),t.isLoading?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading repositories…"}):t.isError?e.jsxs(j,{variant:"destructive",children:[e.jsx(D,{className:"h-4 w-4"}),e.jsx(y,{children:"Unable to load repositories. Ensure GitHub access is configured."})]}):t.data&&t.data.length>0?e.jsx("div",{className:"grid gap-3 grid-cols-1 md:grid-cols-2 lg:grid-cols-3",children:t.data.map(s=>{const r=(i==null?void 0:i.identifier)===s.identifier;return e.jsx(u,{className:`cursor-pointer transition-all ${r?"border-brand bg-accent":"hover:bg-accent/50"}`,onClick:()=>N(s),children:e.jsxs(x,{className:"p-4 space-y-2",children:[e.jsx("div",{className:"font-semibold text-base",children:s.name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.owner}),s.description&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.description}),e.jsxs("div",{className:"text-xs text-muted-foreground pt-2",children:["Default branch: ",s.defaultBranch,s.lastSynced&&` • Synced ${new Date(s.lastSynced).toLocaleTimeString()}`]})]})},s.identifier)})}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No repositories available. Connect GitHub to continue."})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"module",children:"Module"}),e.jsx(T,{id:"module",value:b,onChange:s=>M(s.target.value),placeholder:"module.py"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"entrypoint",children:"Entrypoint"}),e.jsx(T,{id:"entrypoint",value:w,onChange:s=>P(s.target.value),placeholder:"main"})]})]}),e.jsxs("div",{className:"flex gap-3 flex-wrap",children:[e.jsx(p,{onClick:()=>n.mutate(),disabled:!i||n.isPending,children:n.isPending?"Opening…":"Open Repository"}),e.jsx(p,{variant:"outline",onClick:()=>f.mutate(),disabled:f.isPending||n.isError||!d,children:f.isPending?"Scanning…":"Run Reverse Scan"})]}),n.isSuccess&&d&&e.jsxs(j,{variant:"success",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsxs(y,{children:["Repository ",e.jsx("strong",{children:d.name})," synced from ",d.owner,"."]})]}),n.isError&&e.jsxs(j,{variant:"destructive",children:[e.jsx(D,{className:"h-4 w-4"}),e.jsx(y,{children:"Unable to open repository. Check your permissions and try again."})]})]})]}),e.jsxs(u,{children:[e.jsx($,{children:e.jsx(L,{children:"Repository Scan Timeline"})}),e.jsx(x,{children:c.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Trigger reverse mode to view progress checkpoints."}):e.jsx(Q,{className:"h-[400px]",children:e.jsx("ol",{className:"space-y-4",children:c.map(s=>e.jsxs("li",{className:"border-l-2 border-brand/50 pl-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(I,{variant:V[s.status]??"secondary",children:s.label}),e.jsx("span",{className:"text-sm",children:s.message})]}),s.actions&&s.actions.length>0&&e.jsx("div",{className:"flex gap-2 flex-wrap",children:s.actions.map(r=>e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>q(`${s.label}: ${r.label}${r.value?` (${r.value})`:""}`),children:r.label},r.label))}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.timestamp?new Date(s.timestamp).toLocaleTimeString():"Awaiting timestamp"})]},s.id))})})})]}),C&&e.jsx(u,{className:"bg-accent/50",children:e.jsxs(x,{className:"pt-6 space-y-1",children:[e.jsx("div",{className:"font-semibold",children:"Action"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:C})]})})]})}export{re as RepositoryView};
