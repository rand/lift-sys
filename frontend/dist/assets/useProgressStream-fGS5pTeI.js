import{r as u}from"./vendor-react-Cn3fHe9B.js";import{f as y}from"./index-B5PD6UuN.js";const i=new Set,a=new Set,p=200;let c=[],n=null,g="idle",m="/ws/progress";function E(e){if(typeof e=="string"){try{const t=JSON.parse(e);if(t&&typeof t=="object")return{timestamp:new Date().toISOString(),type:typeof t.type=="string"?t.type:"event",...t}}catch{return{type:"text",message:e,timestamp:new Date().toISOString()}}return{type:"text",message:e,timestamp:new Date().toISOString()}}return e&&typeof e=="object"?{timestamp:new Date().toISOString(),type:"event",...e}:{type:"unknown",timestamp:new Date().toISOString(),value:e}}function L(e){const t=y.defaults.baseURL??window.location.origin,r=new URL(e,t);return r.protocol=r.protocol.replace("http","ws"),r.toString()}function h(e){c=[...c,e].slice(-p);for(const t of i)t(e)}function s(e){g=e;for(const t of a)t(e)}function O(e){if(n&&m!==e&&(n.close(),n=null),!n){m=e,queueMicrotask(()=>s("connecting"));try{n=new WebSocket(L(e))}catch{s("error");return}n.addEventListener("open",()=>s("open")),n.addEventListener("close",()=>{s("closed"),n=null}),n.addEventListener("error",()=>s("error")),n.addEventListener("message",t=>{h(E(t.data))})}}function x(e="/ws/progress"){const[t,r]=u.useState(()=>c),[d,v]=u.useState(g);return u.useEffect(()=>{O(e);const f=l=>{r(w=>{const o=[...w,l];return o.length>p?o.slice(o.length-p):o})},S=l=>{v(l)};return i.add(f),a.add(S),()=>{i.delete(f),a.delete(S),!i.size&&n&&(n.close(),n=null,s("closed"))}},[e]),{events:t,status:d,clear:()=>{r([]),c=[]}}}export{x as u};
